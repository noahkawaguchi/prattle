[English](README.md) | [日本語](README.ja.md)

# Prattle

Prattle（プラットル）は、RustでTLS暗号化されたTCPチャットサーバーです。非同期I/O、並行クライアント処理、ネットワークプロトコル設計、リソースの適切な管理などのシステムプログラミングの概念を習得するためのプロジェクトです。

## 目次

1. [機能](#機能)
2. [技術スタック](#技術スタック)
3. [アーキテクチャ](#アーキテクチャ)
4. [コマンド](#コマンド)
5. [サーバーの実行](#サーバーの実行)
6. [クライアントとして接続](#クライアントとして接続)
7. [テストの実行](#テストの実行)
8. [プロジェクトの目標](#プロジェクトの目標)

## 機能

- **TLS暗号化**：クライアントとサーバー間の通信はすべてRustlsで暗号化
- **並行クライアント処理**：Tokioの非同期ランタイムで共有状態とメッセージパッシングの両方を使用し、複数のクライアントを同時にサポート
- **コマンドシステム**：チャット、アクション、サーバークエリのためのシンプルなテキストベースのプロトコル
- **バックプレッシャー処理**：遅いクライアントを認識し、遅延が発生した場合に警告
- **グレースフルシャットダウン**：クライアントへの適切な通知と接続のドレイニングでサーバーのシャットダウンをクリーンに処理
- **厳格なコード品質とテスト**：Clippyを使用して`unsafe`、`unwrap`、`expect`を完全に禁止し、包括的なテストスイートを含んで、すべてのチェックはCIで実施

## 技術スタック

- **[Rust](https://github.com/rust-lang/rust)** - パフォーマンスと並行性の安全性のために選択
- **[Tokio](https://github.com/tokio-rs/tokio)** - 並行クライアント接続を処理するための非同期ランタイム
- **[Rustls](https://github.com/rustls/rustls)** - 安全な暗号化のためのモダンなTLSライブラリ
- **[Tracing](https://github.com/tokio-rs/tracing)** - 可観測性のための構造化ログ

## アーキテクチャ

Prattleはブロードキャストチャンネルアーキテクチャを使用しています。

1. サーバーがTLS接続を受け入れ、クライアントごとにタスクを生成
2. クライアントは接続時に一意のユーザー名を選択
3. メッセージは`tokio::sync::broadcast`チャンネルを通じてブロードキャスト
4. 各クライアントタスクは、ブロードキャストの受信、ユーザー入力の処理、シャットダウンシグナルのリスニングを並行して管理
5. グレースフルシャットダウン（別のブロードキャストチャンネル経由）は、クライアントごとおよびグローバルにタイムアウト付きで双方向の`close_notify`を待機

## コマンド

```
/quit             サーバーから退出
/help             ヘルプメッセージを表示
/who              オンラインユーザーを一覧表示
/action <action>  アクションをブロードキャスト（例：/action waves）
[other]           通常のメッセージを送信
```

## サーバーの実行

Rustツールチェーンは[こちら](https://rust-lang.org/tools/install/)の説明に従ってインストールでき、その後`cargo`コマンドが利用可能になります。

```bash
cargo run
```

サーバーはデフォルトで`127.0.0.1:8000`にバインドします。`BIND_ADDR`環境変数で上書きできます。

```bash
BIND_ADDR=0.0.0.0:9000 cargo run
```

## クライアントとして接続

> [!NOTE]
> Prattleは開発用に自己署名証明書を使用しているため、接続時に証明書を受け入れる必要があります。

`openssl s_client`などのTLS対応クライアントを使用して接続し、カスタムの`BIND_ADDR`またはデフォルトの`127.0.0.1:8000`を指定して接続できます。

```bash
openssl s_client -connect 127.0.0.1:8000 -quiet
```

または、コマンドランナーの[just](https://github.com/casey/just)を使用して、単に`just`コマンドを実行して接続できます。`.env`ファイルに`BIND_ADDR`環境変数が存在する場合、自動的に読み取られます。存在しない場合、サーバーと同じデフォルトにフォールバックします。

```bash
just
```

## テストの実行

```bash
cargo test
```

ユニットテストと統合テストのスイートには、サーバーを起動し、複数の並行クライアントをシミュレートして以下を検証することが含まれます。

- 並行接続の動作
- ユーザー名の検証と一意性
- コマンドの解析と実行
- マルチクライアントブロードキャスト
- エッジケースを含むグレースフルシャットダウン

## プロジェクトの目標

このプロジェクトは、以下の技術を学び、理解を深めるための演習として作成しました。

- Tokioを直接使用した低レベルの非同期プログラミング
- ネットワークの概念とプロトコル設計
- TLSと暗号化の実践的な活用
- 並行プログラミングの文脈におけるRustの所有権モデル
